#!/bin/sh
while ! grep -q 'Page Setup' /home/user/.config/evince/print-settings; do
  sleep 1
done
file=`grep -oP '(?<=file-name=).*' /home/user/.config/evince/print-settings`
pdffonts $file | grep -q 'Type 1C' && exit 1

if grep -q print-pages=current /home/user/.config/evince/print-settings; then
  start=`grep -oP '(?<=current-page=).*' /home/user/.config/evince/print-settings`
  start=$((start+1))
  end=$start
elif grep -q print-pages=ranges /home/user/.config/evince/print-settings; then
  grep -q '^page-ranges=[0-9]\+\(-[0-9]\+\)\?$' /home/user/.config/evince/print-settings || exit 1
  eval `perl -ne 'print if s/^page-ranges=([0-9]+)(?:-([0-9]+))?$/"start=$1".($2?" end=$2":" end=$1")/e' /home/user/.config/evince/print-settings`
  start=$((start+1))
  end=$((end+1))
fi

printf '\e%%-12345X@PJL\n'
if grep -q print-pages=all /home/user/.config/evince/print-settings; then
  echo @PJL JOB
else
  echo @PJL JOB START=$start END=$end
fi
if grep -q reverse=true /home/user/.config/evince/print-settings; then
  echo @PJL SET DUPLEX=ON
  echo @PJL SET BINDING=LONGEDGE
fi
echo @PJL ENTER LANGUAGE=PDF
cat $file
printf '\e%%-12345X@PJL\n'
echo @PJL EOJ
printf '\e%%-12345X'
